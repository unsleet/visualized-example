<template>
  <div id="container" style="width: 100%;height: 100%;" />
</template>
<script>
import 'ol/ol.css'
import Map from 'ol/Map'
import OSM from 'ol/source/OSM'
import TileLayer from 'ol/layer/Tile'
import View from 'ol/View'
import VectorSource from 'ol/source/Vector'
import VectorLayer from 'ol/layer/Vector'
import Feature from 'ol/Feature'
import LineString from 'ol/geom/LineString'
import Point from 'ol/geom/Point'
import Style from 'ol/style/Style'
import Stroke from 'ol/style/Stroke'
import Fill from 'ol/style/Fill'
import Text from 'ol/style/Text'
import RBush from 'rbush'
export default {
  name: 'Train',
  mounted() {

    const map = new Map({
      layers: [
        new TileLayer({
          source: new OSM()
        })
      ],
      target: 'container',
      view: new View({
        center: [0, 0],
        zoom: 6
      })
    })
    const source = new VectorSource()
    // const strs = '113.89754623174667,34.31818306446076,113.89740139245987,34.31759834289551,113.8972619175911,34.316879510879524,113.89697223901749,34.315372109413154,113.8967415690422,34.3140470981598,113.89656990766527,34.31301176548004,113.89644652605058,34.31222856044769,113.89597982168198,34.30784583091736,113.89587789773941,34.30608093738556,113.89579206705093,34.30286228656769,113.89571160078049,34.29952561855316,113.8956955075264,34.29837226867676,113.89563649892807,34.29696679115296,113.89557749032974,34.29494440555573,113.89551311731339,34.29282009601593,113.8953897356987,34.288957715034485,113.89536291360855,34.287192821502686,113.89529317617416,34.28380250930786,113.8951912522316,34.27965044975281,113.89508396387102,34.27427530288696,113.8948130607605,34.25760269165039,113.89519929885864,34.24837589263916,113.89635801315308,34.227004051208496,113.89725923538208,34.21013832092285,113.89773130416872,34.20228481292725,113.89854669570924,34.19584751129151,113.9005208015442,34.187264442443855,113.90193700790407,34.18284416198731,113.90485525131227,34.175505638122566,113.91034841537477,34.16481971740723,113.91356706619264,34.15992736816406,113.91785860061647,34.154348373413086,113.91891105902133,34.15308870785177,113.92025714844536,34.151446061831145,113.92086833102533,34.15073759066462,113.92305098264741,34.14803890853316,113.9241714961573,34.14663792472987,113.92609164669717,34.1442137165132,113.92681514849534,34.143258150661524,113.92827996205318,34.14131655099462,113.92901422466288,34.140350052163726,113.93002778291702,34.13874328136444,113.9310684800148,34.13759529590607,113.93162608263243,34.136808952845094,113.93192609850058,34.136261488572586,113.9325157964859,34.135407923260495,113.93324639001328,34.134363465241705,113.93475220461849,34.13225325247458,113.93533206787997,34.131406684777765,113.93581950840793,34.130810573560915,113.93644809845921,34.13003358952959,113.93713383806876,34.12916916306343,113.93803383913887,34.12819123782577,113.93912695438331,34.12702552477977,113.93956906308458,34.126535189618366,113.94054398959307,34.12556272773947,113.94183280701185,34.12430350122132,113.94260936147158,34.123593868164946,113.94332169662334,34.12296515859051,113.94428913449372,34.12213576251613,113.94500141351095,34.12154985714503,113.94648791912367,34.120354535519354,113.94755893556308,34.119504733920536,113.9489101637304,34.118431346760254,113.94979912111747,34.11769468487661,113.95063307755152,34.11705385356069,113.95124335829837,34.11665026876066,113.95210540889222,34.11615469123427,113.9532671328361,34.11545010240005,113.95623903867364,34.11362671915049,113.95805348439815,34.11253362279968,113.96019857077346,34.11126710235227,113.9608089121749,34.110906191425975,113.96311021583435,34.10981157759964,113.96510042092282,34.108867915337626,113.96633659776361,34.108285557729296,113.9672250045131,34.107891518611616,113.96834881426723,34.10736283973926,113.96931186038286,34.10692028111037,113.971634825723,34.10584306160808,113.97596629826549,34.10386335466499,113.97842747301766,34.10272987149993,113.98150915088605,34.10133709451815,113.98596845600694,34.09941366725478,113.98961688386674,34.09777217005314,113.99489122034275,34.09536451883755,113.99883905929289,34.09361603465437,114.00579359188454,34.09044157981901,114.00987192271462,34.08863090090846,114.0149976214163,34.08622404952051,114.01806895829398,34.084831686668004,114.02686542163558,34.080883323693186,114.03089054754051,34.07919975419834,114.03425238959488,34.07804381376816,114.03891400789364,34.07658044481087,114.04174122425223,34.07579100644375,114.04481828212738,34.075180292129524,114.04833734035492,34.07444000244141,114.0522962808609,34.07382845878602,114.05740320682527,34.073206186294556,114.06091153621675,34.07290577888489,114.06431257724763,34.07251954078674,114.06603991985322,34.07235860824585,114.0817952156067,34.070491790771484,114.0982747077942,34.06890392303467,114.11771535873415,34.06667232513428,114.14260625839233,34.064011573791504,114.14852857589722,34.06328201293945,114.15174722671509,34.06293869018555,114.15496587753296,34.06233787536621,114.15839910507202,34.06156539916992,114.1619610786438,34.060750007629395,114.16560888290405,34.05980587005615,114.16921377182007,34.058775901794434,114.17354822158815,34.05735969543457,114.18045759201051,34.05478477478027,114.18483495712282,34.05332565307617,114.18946981430055,34.05160903930664,114.19517755508424,34.049720764160156,114.20079946517946,34.047746658325195,114.20762300491334,34.045257568359375,114.216206073761,34.042296409606934,114.2233729362488,34.03989315032959,114.23586130142213,34.034743309020996,114.24646139144899,34.03036594390869,114.25182580947877,34.02864933013916,114.25791978836061,34.02658939361572,114.26470041275026,34.02534484863281,114.26894903182985,34.024786949157715,114.27238225936891,34.02444362640381,114.27585840225221,34.024057388305664,114.28092241287233,34.023542404174805,114.28401231765748,34.0231990814209,114.28701639175416,34.02268409729004,114.28843259811403,34.02242660522461,114.29040670394899,34.021525382995605'
    const strs = '-5639523.95, -3501274.52, 0, 0, 738232, 23223'.split(',')
    const coords = []
    for (let i = 0, len = strs.length; i < len; i += 2) {
      coords.push([parseFloat((strs[i])), parseFloat((strs[i + 1]))])
    }
    const line = new LineString(coords)
    const feature = new Feature({ geometry: line })
    source.addFeature(feature)

    function abc(feature, res) {
      //轨迹线图形
      var trackLine= feature.getGeometry();
      const styles = [
        new Style({
          stroke: new Stroke({
            color: [0, 0, 0, 0.6],
            width: 2,
            lineDash: [4,8]
          })
        }),
        new Style({
          stroke: new Stroke({
            color: [255, 255, 255, 0.6],
            width: 2,
            lineDash: [4,8],
            lineDashOffset: 6
          })
        })
      ]
      //对segments建立btree索引
      let tree= new RBush(16);//路段数
      trackLine.forEachSegment(function(start, end) {
        var dx = end[0] - start[0];
        var dy = end[1] - start[1];
        //计算每个segment的方向，即箭头旋转方向
        let rotation = Math.atan2(dy, dx);
        let geom=new LineString([start,end]);
        let extent=geom.getExtent();
        var item = {
          minX: extent[0],
          minY: extent[1],
          maxX: extent[2],
          maxY: extent[3],
          geom: geom,
          rotation:rotation
        };
        tree.insert(item);
      });
      //轨迹地理长度
      let length=trackLine.getLength();
      //像素间隔步长
      let stpes=240;//像素步长间隔
      //将像素步长转实际地理距离步长
      let geo_steps=stpes*res;
      //箭头总数
      let arrowsNum=parseInt(length/geo_steps);
      for(let i=1;i<arrowsNum;i++){
        let arraw_coor=trackLine.getCoordinateAt(i*1.0/arrowsNum);
        let tol=10;//查询设置的点的容差，测试地图单位是米。如果是4326坐标系单位为度的话，改成0.0001.
        let arraw_coor_buffer=[arraw_coor[0]-tol,arraw_coor[1]-tol,arraw_coor[0]+tol,arraw_coor[1]+tol];
        //进行btree查询
        var treeSearch = tree.search({
          minX: arraw_coor_buffer[0],
          minY: arraw_coor_buffer[1],
          maxX: arraw_coor_buffer[2],
          maxY: arraw_coor_buffer[3]
        });
        let arrow_rotation;
        //只查询一个，那么肯定是它了，直接返回
        if(treeSearch.length==1)
          arrow_rotation=treeSearch[0].rotation;
        else if(treeSearch.length>1){
          let results=treeSearch.filter(function(item){
            //箭头点与segment相交，返回结果。该方法实测不是很准，可能是计算中间结果
            //保存到小数精度导致查询有点问题
            // if(item.geom.intersectsCoordinate(arraw_coor))
            //   return true;

            //换一种方案，设置一个稍小的容差，消除精度问题
            let _tol=1;//消除精度误差的容差
            if(item.geom.intersectsExtent([arraw_coor[0]-_tol,arraw_coor[1]-_tol,arraw_coor[0]+_tol,arraw_coor[1]+_tol]))
              return true;
          })
          if(results.length>0)
            arrow_rotation=results[0].rotation;
        }
        styles.push(new Style({
          geometry: new Point(arraw_coor),
          text: new Text({
            font: '12px Calibri,sans-serif',
            fill: new Fill({
              color: '#2600ff'
            }),
            stroke: new Stroke({
              color: '#fff6dc',
              width: 3
            }),
            text: '郑阜高铁',
            rotation: -arrow_rotation
          })
        }))
      }
      return styles;
    }

    const vector = new VectorLayer({
      source: source,
      style: abc
    })
    map.addLayer(vector)
  }
}
</script>
